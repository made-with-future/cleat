GCP_PROJECT_ID = nn-balloons

.PHONY: \
run build deploy promote \
dc-build \
dj-collectstatic dj-dumpdata dj-makemigrations dj-migrate-dev dj-migrate-production dj-loaddata \
py-install py-gen-random-secret-key \
npm-webpack-build npm-tailwindcss-build \
gcp-activate gcp-adc-login gcp-init gcp-set-config gcp-deploy gcp-promote \
tf-init tf-init-upgrade tf-plan tf-apply-refresh tf-apply

run:
	docker compose up

build:
	make npm-webpack-build
	make npm-tailwindcss-build
	make dj-collectstatic

deploy:
	make build
	make gcp-deploy

promote:
	make gcp-promote

dc-build:
	# Builds all services, as far as extra profiles go, we only have migrate, if we added others
	# we'd need to add those to the list below if we want it to build everything
	docker compose --profile migrate build

dc-prune-orphans:
	docker compose down --remove-orphans

dj-init:
	docker compose run -e "DJANGO_SUPERUSER_USERNAME=dev" -e "DJANGO_SUPERUSER_PASSWORD=dev" --rm backend python manage.py createsuperuser --email dev@madewithfuture.com --noinput --first_name John --last_name Doe

dj-collectstatic:
	docker compose run --rm backend-wo-db python manage.py collectstatic --noinput

dj-makemigrations:
	docker compose run --rm backend python manage.py makemigrations

dj-migrate-dev:
	docker compose run --rm backend python manage.py migrate

dj-migrate-production:
	docker compose up cloudsql-proxy -d
	op run --env-file="./.env/production_migrate.env" -- docker compose run --rm backend-wo-db python manage.py migrate
	docker compose stop cloudsql-proxy

dj-dumpdata:
	make dj-migrate-dev
	docker compose run --rm backend python manage.py dumpdata --indent 2 --natural-foreign --natural-primary --exclude auth.permission --exclude contenttypes > backend/.fixtures/initial_data.json

dj-loaddata:
	make dj-migrate-dev
	docker compose run --rm backend python manage.py loaddata .fixtures/initial_data.json

dj-sync-legacy-user-roles:
	docker compose run --rm backend python manage.py sync_legacy_user_roles

dj-delete-expired-invites:
	docker compose run --rm backend python manage.py delete_expired_invites

dj-sync-legacy-user-roles-production:
	docker compose up cloudsql-proxy -d
	op run --env-file="./.env/production_migrate.env" -- docker compose run --rm backend-wo-db python manage.py sync_legacy_user_roles
	docker compose stop cloudsql-proxy

dj-sync-to-mailchimp-production:
	docker compose up cloudsql-proxy -d
	op run --env-file="./.env/production_migrate.env" -- docker compose run --rm backend-wo-db python manage.py sync_to_mailchimp
	docker compose stop cloudsql-proxy

dj-gen-random-secret-key:
	docker compose run --rm backend python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())'

dj-reset-db:
	docker compose run --rm backend python manage.py reset_db --noinput
	make dj-migrate-dev

py-pip-upgrade:
	docker compose build backend

py-install:
	docker compose build backend

npm-webpack-build:
	docker compose run --rm backend-node npm run webpack-build

npm-tailwindcss-build:
	docker compose run --rm backend-node npm run tailwindcss-build

gcp-activate:
	gcloud config configurations activate $(GCP_PROJECT_ID)
	gcloud auth application-default set-quota-project $(GCP_PROJECT_ID)

gcp-adc-login:
	gcloud config configurations activate $(GCP_PROJECT_ID)

	gcloud auth application-default login --project $(GCP_PROJECT_ID)
	# Authorization for gcloud CLI
	gcloud auth login --project $(GCP_PROJECT_ID)

	gcloud auth application-default set-quota-project $(GCP_PROJECT_ID)

gcp-init:
	gcloud config configurations create $(GCP_PROJECT_ID)
	make gcp-set-config

gcp-set-config:
	make gcp-activate
	@printf "Enter your GCP account email:"; \
		read email; \
		gcloud config set account $$email
	gcloud config set project $(GCP_PROJECT_ID)
	gcloud config set app/promote_by_default false

gcp-deploy:
	make gcp-activate
	@printf "\nEnter version name, or return to skip:"; read VERSION; \
	if [ -z "$${VERSION}" ]; then \
		gcloud app deploy backend/app.yaml; \
	else \
		gcloud app deploy backend/app.yaml --version $$VERSION; \
	fi

gcp-promote:
	make gcp-activate
	@printf "Enter version to promote:"; \
		read version; \
		gcloud app versions migrate $$version

tf-init:
	make gcp-activate
	op run --env-file="./.env/production.env" -- terraform -chdir=terraform/production init

tf-init-upgrade:
	make gcp-activate
	op run --env-file="./.env/production.env" -- terraform -chdir=terraform/production init -upgrade

tf-plan:
	make gcp-activate
	op run --env-file="./.env/production.env" -- terraform -chdir=terraform/production plan

tf-apply-refresh:
	make gcp-activate
	op run --env-file="./.env/production.env" -- terraform -chdir=terraform/production apply -refresh-only

tf-apply:
	make gcp-activate
	op run --env-file="./.env/production.env" -- terraform -chdir=terraform/production apply
