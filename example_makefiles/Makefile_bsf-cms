PROJECT_ID = bsf-cms

.PHONY: \
run build deploy promote \
dc-build \
dj-collectstatic dj-dumpdata dj-makemigrations dj-migrate-dev dj-migrate-production dj-loaddata dj-test-debug dj-import \
py-install py-gen-random-secret-key \
npm-webpack-build npm-tailwindcss-build \
gcp-activate gcp-adc-login gcp-init gcp-set-config gcp-deploy gcp-promote \
tf-init tf-init-upgrade tf-plan tf-apply-refresh tf-apply

run:
	docker compose up --remove-orphans

stop:
	docker compose down --remove-orphans

build:
	make npm-build
	make dj-collectstatic

deploy:
	# TODO Azure deployment process

test: dj-test

db-reset:
	make stop
	docker volume rm bsf-cms_db
	make dj-migrate-dev
	make dj-init
	make dj-fetch-wordgo
	make dj-import
	make run

dc-build:
	# Builds all services, as far as extra profiles go, we only have migrate, if we added others
	# we'd need to add those to the list below if we want it to build everything
	docker compose --profile "*" build

dc-remove-orphans:
	docker compose down --remove-orphans

dj-init:
	docker compose run -e "DJANGO_SUPERUSER_USERNAME=dev" -e "DJANGO_SUPERUSER_PASSWORD=dev" --rm backend uv run python manage.py createsuperuser --email dev@madewithfuture.com --noinput

dj-collectstatic:
	docker compose run --rm backend uv run python manage.py collectstatic --noinput --clear

dj-makemigrations:
	docker compose run --rm backend uv run python manage.py makemigrations

dj-makemigrations-merge:
	docker compose run --rm backend uv run python manage.py makemigrations --merge

dj-makemessages:
	docker compose run --rm backend uv run python manage.py makemessages -l es_419 -l zh_CN

dj-migrate-dev:
	docker compose run --rm backend uv run python manage.py migrate

dj-dumpdata:
	make dj-migrate-dev
	docker compose run --rm backend uv run python manage.py dumpdata --indent 2 --natural-foreign --natural-primary --exclude auth.permission --exclude contenttypes > backend/.fixtures/initial_data.json

dj-loaddata:
	make dj-migrate-dev
	# clear data first
	docker compose run --rm backend uv run python manage.py flush --noinput
	docker compose run --rm backend uv run python manage.py loaddata .fixtures/initial_data.json

dj-fixtures-for-testserver:
	sed -i '' 's/localhost/testserver/g' backend/api/fixtures/platforms.json

dj-fixtree:
	docker compose run --rm backend uv run python manage.py fixtree

dj-test:
	docker compose run --rm backend uv run python manage.py test --settings=root.settings.test

dj-update-index:
	docker compose run --rm backend uv run python manage.py update_index --backend default

dj-compilemessages:
	docker compose run --rm backend uv run python manage.py compilemessages --settings=root.settings.dev

dj-codegen:
	docker compose run --rm backend uv run python manage.py codegen

dj-fetch-wordgo:
	docker compose run --rm backend uv run python manage.py fetch_wordgo 

dj-import:
	docker compose run --rm backend uv run python manage.py import_wordgo 

py-install:
	docker compose build backend

py-gen-random-secret-key:
	docker compose run --rm backend-wo-db python -c 'from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())'

npm-run:
	docker compose run --rm backend-node npm run start

npm-build:
	docker compose run --rm backend-node npm run build
